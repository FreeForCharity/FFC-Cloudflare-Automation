name: '89. Repo - Create GitHub Repo [Repo]'

on:
  workflow_dispatch:
    inputs:
      RepoName:
        description: 'Name of the new repository (Format: FFC-EX-<domainname>)'
        required: true
        type: string
      Description:
        description: 'Description of the repository'
        required: false
        default: 'Created via automation'
        type: string
      TemplateRepo:
        description: 'Template repository to use'
        required: true
        default: 'FreeForCharity/FFC_Single_Page_Template'
        type: choice
        options:
          - FreeForCharity/FFC_Single_Page_Template
          - FreeForCharity/FFC-IN-Single_Page_Template_Jekell
      Visibility:
        description: 'Visibility'
        required: true
        default: 'public'
        type: choice
        options:
          - public
      EnableIssues:
        description: 'Enable Issues'
        required: false
        default: true
        type: boolean
      EnablePages:
        description: 'Enable GitHub Pages'
        required: false
        default: false
        type: boolean
      PagesDomainType:
        description: 'GitHub Pages domain configuration'
        required: false
        default: 'apex'
        type: choice
        options:
          - apex
          - staging
          - github-default
      CNAME:
        description: 'Custom Domain (CNAME) - Leave empty to auto-detect based on PagesDomainType'
        required: false
        type: string
      DryRun:
        description: 'Dry Run (Preview only)'
        required: false
        default: false
        type: boolean

jobs:
  create-repo:
    runs-on: windows-latest
    environment: github-prod
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create Repository
        env:
          GH_TOKEN: ${{ secrets.CBM_TOKEN }} # Needs repo creation permissions
        run: |
          $params = @{
              RepoName            = "${{ inputs.RepoName }}"
              Description         = "${{ inputs.Description }}"
              TemplateRepo        = "${{ inputs.TemplateRepo }}"
              Visibility          = "${{ inputs.Visibility }}"
              EnableIssues        = [System.Convert]::ToBoolean("${{ inputs.EnableIssues }}")
              EnablePages         = [System.Convert]::ToBoolean("${{ inputs.EnablePages }}")
              PagesDomainType     = "${{ inputs.PagesDomainType }}"
              DryRun              = [System.Convert]::ToBoolean("${{ inputs.DryRun }}")
          }

          if (-not [string]::IsNullOrWhiteSpace("${{ inputs.CNAME }}")) {
              $params.Add("CNAME", "${{ inputs.CNAME }}")
          }

          ./scripts/Create-GitHubRepo.ps1 @params
          $global:LASTEXITCODE = 0
