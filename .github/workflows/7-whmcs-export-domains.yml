name: '07. WHMCS - Export Domains (Report)'
run-name: 'WHMCS Export Domains'

on:
  workflow_dispatch:
    inputs:
      api_url:
        description: 'WHMCS API endpoint (e.g., https://freeforcharity.org/hub/includes/api.php)'
        required: false
        type: string
        default: 'https://freeforcharity.org/hub/includes/api.php'
      output_file:
        description: 'Output CSV filename'
        required: false
        type: string
        default: 'artifacts/whmcs/whmcs_domains.csv'

permissions:
  contents: read
  actions: read

jobs:
  export_domains:
    runs-on: windows-latest
    environment: whmcs-prod

    steps:
      - uses: actions/checkout@v4

      - name: Validate required WHMCS secrets
        shell: pwsh
        env:
          WHMCS_API_SECRET: ${{ secrets.ZBBEPFQ5W7RCSIME0NOQOYRQIDGTKBPU }}
        run: |
          $ErrorActionPreference = 'Stop'

          if ([string]::IsNullOrWhiteSpace($env:WHMCS_API_SECRET)) {
            throw "Missing secret in environment 'whmcs-prod': ZBBEPFQ5W7RCSIME0NOQOYRQIDGTKBPU"
          }

      - name: Export domains (read-only)
        shell: pwsh
        env:
          WHMCS_API_URL: ${{ inputs.api_url }}
          WHMCS_API_IDENTIFIER: 'zbBEpfq5W7RCSImE0NOqoYrqIDGTkBPu'
          WHMCS_API_SECRET: ${{ secrets.ZBBEPFQ5W7RCSIME0NOQOYRQIDGTKBPU }}
          WHMCS_API_ACCESS_KEY: ${{ secrets.WHMCS_API_ACCESS_KEY }}
        run: |
          $ErrorActionPreference = 'Stop'
          $out = "${{ inputs.output_file }}"

          $dir = Split-Path -Parent $out
          if (-not [string]::IsNullOrWhiteSpace($dir)) {
            New-Item -ItemType Directory -Force -Path $dir | Out-Null
          }

          & pwsh -NoProfile -File .\scripts\whmcs-domain-export.ps1 -ApiUrl $env:WHMCS_API_URL -OutputFile $out

          if ($LASTEXITCODE -ne 0) {
            throw "WHMCS export script failed with exit code $LASTEXITCODE. See logs above."
          }

          if (-not (Test-Path $out)) {
            throw "Expected output file not found: $out"
          }

          "## WHMCS domain export" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          "- Output path: $out" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          "- Artifact name: whmcs_domains" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          "- Download: $($env:GITHUB_SERVER_URL)/$($env:GITHUB_REPOSITORY)/actions/runs/$($env:GITHUB_RUN_ID)" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8

      - name: Upload CSV Artifact
        uses: actions/upload-artifact@v6
        with:
          name: whmcs_domains
          path: ${{ inputs.output_file }}
          if-no-files-found: error

      - name: Add artifact page link to summary
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          $ErrorActionPreference = 'Stop'

          $repo = $env:GITHUB_REPOSITORY
          $runId = $env:GITHUB_RUN_ID
          $headers = @{
            Authorization = "Bearer $env:GH_TOKEN"
            Accept        = "application/vnd.github+json"
          }

          $apiUrl = "https://api.github.com/repos/$repo/actions/runs/$runId/artifacts"
          $resp = Invoke-RestMethod -Method Get -Uri $apiUrl -Headers $headers
          $artifact = $resp.artifacts | Where-Object { $_.name -eq 'whmcs_domains' } | Select-Object -First 1

          if ($null -eq $artifact) {
            "- Artifact page: (artifact not found in run artifacts list)" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
            exit 0
          }

          $artifactUrl = "https://github.com/$repo/actions/runs/$runId/artifacts/$($artifact.id)"
          "- Artifact page: $artifactUrl" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
