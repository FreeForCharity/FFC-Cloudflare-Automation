name: '11. M365 - Domain Preflight (Read-only)'

permissions:
  contents: read
  id-token: write

on:
  workflow_dispatch:
    inputs:
      domain:
        description: Domain to validate (e.g., example.org)
        required: true
        type: string

jobs:
  graph:
    runs-on: ubuntu-latest
    environment: m365-prod

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate required secrets
        shell: bash
        run: |
          if [ -z "${{ secrets.FFC_AZURE_CLIENT_ID }}" ]; then
            echo "::error::FFC_AZURE_CLIENT_ID secret is not set (environment: m365-prod)";
            exit 1;
          fi
          if [ -z "${{ secrets.FFC_AZURE_TENANT_ID }}" ]; then
            echo "::error::FFC_AZURE_TENANT_ID secret is not set (environment: m365-prod)";
            exit 1;
          fi

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.FFC_AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.FFC_AZURE_TENANT_ID }}
          allow-no-subscriptions: true

      - name: Acquire Graph token
        id: graph
        shell: bash
        run: |
          token=$(az account get-access-token --resource-type ms-graph --query accessToken -o tsv)
          if [ -z "$token" ]; then
            echo "::error::Failed to acquire Microsoft Graph token";
            exit 1;
          fi
          echo "access_token=$token" >> "$GITHUB_OUTPUT"

      - name: Run domain preflight
        shell: pwsh
        env:
          GRAPH_ACCESS_TOKEN: ${{ steps.graph.outputs.access_token }}
        run: |
          pwsh -NoProfile -File scripts/m365-domain-preflight.ps1 -Domain "${{ inputs.domain }}" -AccessToken $env:GRAPH_ACCESS_TOKEN -SkipCloudflare

  cloudflare:
    runs-on: ubuntu-latest
    environment: cloudflare-prod
    needs: [graph]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate required secrets
        shell: bash
        run: |
          if [ -z "${{ secrets.CLOUDFLARE_API_KEY_DNS_ONLY }}" ]; then
            echo "::error::CLOUDFLARE_API_KEY_DNS_ONLY secret is not set (environment: cloudflare-prod)";
            exit 1;
          fi

      - name: Run Cloudflare audit portion
        shell: pwsh
        env:
          CLOUDFLARE_API_KEY_DNS_ONLY: ${{ secrets.CLOUDFLARE_API_KEY_DNS_ONLY }}
        run: |
          pwsh -NoProfile -File scripts/m365-domain-preflight.ps1 -Domain "${{ inputs.domain }}" -SkipGraph
