name: '33. WHMCS -> Zeffy Payments Import (Draft)'
run-name: 'WHMCS -> Zeffy Import Draft'

on:
  workflow_dispatch:
    inputs:
      api_url:
        description: 'WHMCS API endpoint (e.g., https://freeforcharity.org/hub/includes/api.php)'
        required: false
        type: string
        default: 'https://freeforcharity.org/hub/includes/api.php'
      clients_output:
        description: 'WHMCS clients CSV output path'
        required: false
        type: string
        default: 'artifacts/whmcs/whmcs_clients.csv'
      transactions_output:
        description: 'WHMCS transactions CSV output path'
        required: false
        type: string
        default: 'artifacts/whmcs/whmcs_transactions.csv'
      invoices_output:
        description: 'WHMCS invoices CSV output path (used to include $0 invoices)'
        required: false
        type: string
        default: 'artifacts/whmcs/whmcs_invoices.csv'
      zeffy_output:
        description: 'Zeffy draft CSV output path'
        required: false
        type: string
        default: 'artifacts/zeffy/zeffy_payments_import_draft.csv'

      start_date:
        description: 'Optional start date filter for WHMCS transactions (YYYY-MM-DD)'
        required: false
        type: string
        default: ''

      end_date:
        description: 'Optional end date filter for WHMCS transactions (YYYY-MM-DD)'
        required: false
        type: string
        default: ''

      max_rows:
        description: 'Maximum number of WHMCS transactions to export (safety cap)'
        required: false
        type: string
        default: '200000'

      max_rows_per_file:
        description: 'Maximum Zeffy rows per CSV file (Zeffy import limit is 10,000)'
        required: false
        type: string
        default: '10000'

      include_zero_invoices:
        description: "Include $0 invoices as 'free' payments (to capture contacts)"
        required: false
        type: boolean
        default: true

permissions:
  contents: read

jobs:
  whmcs_to_zeffy_draft:
    runs-on: windows-latest
    environment: whmcs-prod

    steps:
      - uses: actions/checkout@v4

      - name: Validate required WHMCS secrets
        shell: pwsh
        env:
          WHMCS_API_SECRET: ${{ secrets.ZBBEPFQ5W7RCSIME0NOQOYRQIDGTKBPU }}
        run: |
          $ErrorActionPreference = 'Stop'

          if ([string]::IsNullOrWhiteSpace($env:WHMCS_API_SECRET)) {
            throw "Missing secret in environment 'whmcs-prod': ZBBEPFQ5W7RCSIME0NOQOYRQIDGTKBPU"
          }

      - name: Export clients (read-only)
        shell: pwsh
        env:
          WHMCS_API_URL: ${{ inputs.api_url }}
          WHMCS_API_IDENTIFIER: 'zbBEpfq5W7RCSImE0NOqoYrqIDGTkBPu'
          WHMCS_API_SECRET: ${{ secrets.ZBBEPFQ5W7RCSIME0NOQOYRQIDGTKBPU }}
          WHMCS_API_ACCESS_KEY: ${{ secrets.WHMCS_API_ACCESS_KEY }}
        run: |
          $ErrorActionPreference = 'Stop'

          $out = "${{ inputs.clients_output }}"
          $dir = Split-Path -Parent $out
          if (-not [string]::IsNullOrWhiteSpace($dir)) {
            New-Item -ItemType Directory -Force -Path $dir | Out-Null
          }

          & pwsh -NoProfile -File .\scripts\whmcs-clients-export.ps1 -ApiUrl $env:WHMCS_API_URL -OutputFile $out

          if ($LASTEXITCODE -ne 0) {
            throw "WHMCS clients export failed with exit code $LASTEXITCODE."
          }

          if (-not (Test-Path $out)) {
            throw "Expected output file not found: $out"
          }

      - name: Export transactions (read-only)
        shell: pwsh
        env:
          WHMCS_API_URL: ${{ inputs.api_url }}
          WHMCS_API_IDENTIFIER: 'zbBEpfq5W7RCSImE0NOqoYrqIDGTkBPu'
          WHMCS_API_SECRET: ${{ secrets.ZBBEPFQ5W7RCSIME0NOQOYRQIDGTKBPU }}
          WHMCS_API_ACCESS_KEY: ${{ secrets.WHMCS_API_ACCESS_KEY }}
        run: |
          $ErrorActionPreference = 'Stop'

          $out = "${{ inputs.transactions_output }}"
          $dir = Split-Path -Parent $out
          if (-not [string]::IsNullOrWhiteSpace($dir)) {
            New-Item -ItemType Directory -Force -Path $dir | Out-Null
          }

          $args = @(
            '-ApiUrl', $env:WHMCS_API_URL,
            '-OutputFile', $out
          )

          $maxRows = "${{ inputs.max_rows }}".Trim()
          if (-not [string]::IsNullOrWhiteSpace($maxRows)) {
            $args += @('-MaxRows', $maxRows)
          }

          $startDate = "${{ inputs.start_date }}".Trim()
          if (-not [string]::IsNullOrWhiteSpace($startDate)) {
            $args += @('-StartDate', $startDate)
          }

          $endDate = "${{ inputs.end_date }}".Trim()
          if (-not [string]::IsNullOrWhiteSpace($endDate)) {
            $args += @('-EndDate', $endDate)
          }

          & pwsh -NoProfile -File .\scripts\whmcs-transactions-export.ps1 @args

          if ($LASTEXITCODE -ne 0) {
            throw "WHMCS transactions export failed with exit code $LASTEXITCODE."
          }

          if (-not (Test-Path $out)) {
            throw "Expected output file not found: $out"
          }

      - name: Export invoices (read-only)
        if: ${{ inputs.include_zero_invoices }}
        shell: pwsh
        env:
          WHMCS_API_URL: ${{ inputs.api_url }}
          WHMCS_API_IDENTIFIER: 'zbBEpfq5W7RCSImE0NOqoYrqIDGTkBPu'
          WHMCS_API_SECRET: ${{ secrets.ZBBEPFQ5W7RCSIME0NOQOYRQIDGTKBPU }}
          WHMCS_API_ACCESS_KEY: ${{ secrets.WHMCS_API_ACCESS_KEY }}
        run: |
          $ErrorActionPreference = 'Stop'

          $out = "${{ inputs.invoices_output }}"
          $dir = Split-Path -Parent $out
          if (-not [string]::IsNullOrWhiteSpace($dir)) {
            New-Item -ItemType Directory -Force -Path $dir | Out-Null
          }

          $args = @(
            '-ApiUrl', $env:WHMCS_API_URL,
            '-OutputFile', $out
          )

          $startDate = "${{ inputs.start_date }}".Trim()
          if (-not [string]::IsNullOrWhiteSpace($startDate)) {
            $args += @('-StartDate', $startDate)
          }

          $endDate = "${{ inputs.end_date }}".Trim()
          if (-not [string]::IsNullOrWhiteSpace($endDate)) {
            $args += @('-EndDate', $endDate)
          }

          & pwsh -NoProfile -File .\scripts\whmcs-invoices-export.ps1 @args
          if ($LASTEXITCODE -ne 0) {
            throw "WHMCS invoices export failed with exit code $LASTEXITCODE."
          }

          if (-not (Test-Path $out)) {
            throw "Expected output file not found: $out"
          }

      - name: Lookup invoices for deleted clients (userid=0)
        shell: pwsh
        env:
          WHMCS_API_URL: ${{ inputs.api_url }}
          WHMCS_API_IDENTIFIER: 'zbBEpfq5W7RCSImE0NOqoYrqIDGTkBPu'
          WHMCS_API_SECRET: ${{ secrets.ZBBEPFQ5W7RCSIME0NOQOYRQIDGTKBPU }}
          WHMCS_API_ACCESS_KEY: ${{ secrets.WHMCS_API_ACCESS_KEY }}
        run: |
          $ErrorActionPreference = 'Stop'

          $txPath = "${{ inputs.transactions_output }}"
          if (-not (Test-Path $txPath)) {
            throw "Transactions CSV not found: $txPath"
          }

          $out = 'artifacts/whmcs/whmcs_invoices_deleted_clients.csv'
          $outDir = Split-Path -Parent $out
          if (-not [string]::IsNullOrWhiteSpace($outDir)) {
            New-Item -ItemType Directory -Force -Path $outDir | Out-Null
          }

          $invoiceIds = @(Import-Csv -LiteralPath $txPath |
            Where-Object { $_.userid -eq '0' -and -not [string]::IsNullOrWhiteSpace($_.invoiceid) } |
            Select-Object -ExpandProperty invoiceid -Unique |
            ForEach-Object { $_.ToString().Trim() } |
            Where-Object { -not [string]::IsNullOrWhiteSpace($_) })

          if ($invoiceIds.Count -eq 0) {
            Write-Host 'No userid=0 invoices found; skipping invoice lookup.'
            # Create an empty CSV with headers so the artifact upload is predictable.
            @([pscustomobject]@{ invoiceid=''; userid=''; status=''; date=''; duedate=''; total=''; paymentmethod=''; firstname=''; lastname=''; companyname=''; email=''; address1=''; address2=''; city=''; state=''; postcode=''; country='' }) |
              Export-Csv -NoTypeInformation -Encoding utf8 -Path $out
            exit 0
          }

          $tmpIds = Join-Path -Path $env:RUNNER_TEMP -ChildPath 'deleted_client_invoice_ids.txt'
          $invoiceIds | Sort-Object -Unique | Set-Content -LiteralPath $tmpIds -Encoding utf8

          & pwsh -NoProfile -File .\scripts\whmcs-invoices-lookup.ps1 -ApiUrl $env:WHMCS_API_URL -InvoiceIdFile $tmpIds -OutputFile $out
          if ($LASTEXITCODE -ne 0) {
            throw "WHMCS invoice lookup failed with exit code $LASTEXITCODE."
          }

          $count = (Import-Csv -LiteralPath $out | Where-Object { $_.invoiceid -and $_.status -ne 'ERROR' }).Count
          "- Deleted-client invoices looked up: $count" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8

      - name: Generate Zeffy payments import draft
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          $clients = "${{ inputs.clients_output }}"
          $tx = "${{ inputs.transactions_output }}"
          $invoices = "${{ inputs.invoices_output }}"
          $out = "${{ inputs.zeffy_output }}"

          function Get-ZeffyOutputFiles {
            param([string]$BaseOutputFile)

            $dir = Split-Path -Parent $BaseOutputFile
            if ([string]::IsNullOrWhiteSpace($dir)) { $dir = '.' }

            $baseName = [System.IO.Path]::GetFileNameWithoutExtension($BaseOutputFile)

            $single = @()
            if (Test-Path -LiteralPath $BaseOutputFile) {
              $single = @($BaseOutputFile)
            }

            $parts = @(Get-ChildItem -Path $dir -Filter "$baseName-part*.csv" -File -ErrorAction SilentlyContinue | Select-Object -ExpandProperty FullName)

            if ($single.Count -gt 0 -and $parts.Count -eq 0) {
              return $single
            }

            if ($parts.Count -gt 0) {
              return ($parts | Sort-Object)
            }

            return @()
          }

          $dir = Split-Path -Parent $out
          if (-not [string]::IsNullOrWhiteSpace($dir)) {
            New-Item -ItemType Directory -Force -Path $dir | Out-Null
          }

          $maxRowsPerFile = "${{ inputs.max_rows_per_file }}".Trim()
          $genArgs = @(
            '-ClientsCsv', $clients,
            '-TransactionsCsv', $tx,
            '-OutputFile', $out
          )

          $includeZeroInvoices = "${{ inputs.include_zero_invoices }}".Trim().ToLowerInvariant() -eq 'true'
          if ($includeZeroInvoices -and (Test-Path -LiteralPath $invoices)) {
            $genArgs += @('-InvoicesCsv', $invoices, '-IncludeZeroInvoices')
          }
          if (-not [string]::IsNullOrWhiteSpace($maxRowsPerFile)) {
            $genArgs += @('-MaxRowsPerFile', $maxRowsPerFile)
          }

          & pwsh -NoProfile -File .\scripts\zeffy-payments-import-draft.ps1 @genArgs

          if ($LASTEXITCODE -ne 0) {
            throw "Zeffy draft generation failed with exit code $LASTEXITCODE."
          }

          $files = Get-ZeffyOutputFiles -BaseOutputFile $out
          if (-not $files -or $files.Count -eq 0) {
            throw "Expected Zeffy output file(s) not found. Base: $out"
          }

          # Optional: summarize invoice-derived rows (e.g., $0 invoices) so it's obvious what was added.
          if ($includeZeroInvoices -and (Test-Path -LiteralPath $invoices)) {
            function Get-FirstNumber {
              param([string]$Text)
              if ([string]::IsNullOrWhiteSpace($Text)) { return $null }
              $m = [regex]::Match($Text, '-?\d+(?:\.\d+)?')
              if (-not $m.Success) { return $null }
              return $m.Value
            }

            $txInvoiceIds = @{}
            foreach ($r in (Import-Csv -LiteralPath $tx)) {
              if ($r.invoiceid -and -not [string]::IsNullOrWhiteSpace($r.invoiceid)) {
                $txInvoiceIds[$r.invoiceid.ToString().Trim()] = $true
              }
            }

            $zeroTotal = 0
            $zeroWithTx = 0
            $zeroEligible = 0
            foreach ($inv in (Import-Csv -LiteralPath $invoices)) {
              if (-not $inv.invoiceid) { continue }
              $n = Get-FirstNumber -Text $inv.total
              if ($null -eq $n) { continue }
              $v = $null
              try { $v = [decimal]::Parse($n, [System.Globalization.NumberStyles]::Any, [System.Globalization.CultureInfo]::InvariantCulture) } catch { $v = $null }
              if ($v -ne 0) { continue }
              $zeroTotal++
              $id = $inv.invoiceid.ToString().Trim()
              if ($txInvoiceIds.ContainsKey($id)) {
                $zeroWithTx++
              }
              else {
                $zeroEligible++
              }
            }

            "- include_zero_invoices: true" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
            "- $0 invoices found: $zeroTotal" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
            "- $0 invoices skipped (already had transaction): $zeroWithTx" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
            "- $0 invoices appended (invoice-only): $zeroEligible" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          }
          elseif ($includeZeroInvoices) {
            "- include_zero_invoices: true (invoices file missing; none added)" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          }
          else {
            "- include_zero_invoices: false" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          }

          $envBlock = @()
          $envBlock += 'ZEFFY_OUTPUT_FILES<<EOF'
          $envBlock += ($files -join "`n")
          $envBlock += 'EOF'
          $envBlock -join "`n" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Validate Zeffy CSV headers
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          if ([string]::IsNullOrWhiteSpace($env:ZEFFY_OUTPUT_FILES)) {
            throw 'Missing ZEFFY_OUTPUT_FILES from previous step.'
          }

          $files = @($env:ZEFFY_OUTPUT_FILES -split "`n" | Where-Object { -not [string]::IsNullOrWhiteSpace($_) })
          if ($files.Count -eq 0) {
            throw 'ZEFFY_OUTPUT_FILES was empty.'
          }

          $expected = 'firstName,lastName,amount,address,city,postalCode,country,type,formTitle,rateTitle,email,language,date (MM/DD/YYYY),state/province,paymentMethod,receiptUrl,ticketUrl,receiptNumber,companyName,note,annotation'

          $totalRows = 0
          foreach ($f in $files) {
            $actual = (Get-Content -LiteralPath $f -TotalCount 1) -replace '^\uFEFF',''
            $actual = $actual.Trim() -replace '^"','' -replace '"$',''
            $actual = $actual -replace '","',','

            if ($actual -ne $expected) {
              throw "Zeffy CSV header mismatch in file '$f'. Expected: $expected  Actual: $actual"
            }

            try {
              $count = (Import-Csv -LiteralPath $f).Count
              $totalRows += $count
            }
            catch {
              throw "Failed to count rows in '$f': $($_.Exception.Message)"
            }
          }

          "## WHMCS -> Zeffy import draft" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          "- Zeffy output files: $($files.Count)" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          "- Total Zeffy rows: $totalRows" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          foreach ($f in $files) {
            "  - $f" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          }
          "- Download: $($env:GITHUB_SERVER_URL)/$($env:GITHUB_REPOSITORY)/actions/runs/$($env:GITHUB_RUN_ID)" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          "- Artifacts: $($env:GITHUB_SERVER_URL)/$($env:GITHUB_REPOSITORY)/actions/runs/$($env:GITHUB_RUN_ID)/artifacts" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8

      - name: Upload WHMCS clients
        uses: actions/upload-artifact@v6
        with:
          name: whmcs_clients
          path: ${{ inputs.clients_output }}
          if-no-files-found: error

      - name: Upload WHMCS transactions
        uses: actions/upload-artifact@v6
        with:
          name: whmcs_transactions
          path: ${{ inputs.transactions_output }}
          if-no-files-found: error

      - name: Upload WHMCS invoices
        if: ${{ inputs.include_zero_invoices }}
        uses: actions/upload-artifact@v6
        with:
          name: whmcs_invoices
          path: ${{ inputs.invoices_output }}
          if-no-files-found: error

      - name: Upload WHMCS deleted-client invoices
        uses: actions/upload-artifact@v6
        with:
          name: whmcs_invoices_deleted_clients
          path: artifacts/whmcs/whmcs_invoices_deleted_clients.csv
          if-no-files-found: error

      - name: Upload Zeffy draft
        uses: actions/upload-artifact@v6
        with:
          name: zeffy_payments_import_draft
          path: |
            ${{ inputs.zeffy_output }}
            artifacts/zeffy/*-part*.csv
          if-no-files-found: error
