name: '01. Domain - Status (Check)'
run-name: 'Domain Status: ${{ inputs.domain }}'

on:
  workflow_dispatch:
    inputs:
      domain:
        description: 'Domain name (e.g., example.org)'
        required: true
        type: string
      issue_number:
        description: 'Optional: issue number to comment results back to'
        required: false
        type: number

permissions:
  contents: read
  issues: write
  id-token: write

jobs:
  cloudflare:
    runs-on: windows-latest
    environment: cloudflare-prod

    outputs:
      issues_count: ${{ steps.summary.outputs.issues_count }}
      severe_issues_count: ${{ steps.summary.outputs.severe_issues_count }}
      changes_count: ${{ steps.summary.outputs.changes_count }}

    steps:
      - uses: actions/checkout@v4

      - name: Cloudflare audit + dry-run preview
        id: run
        shell: pwsh
        env:
          CLOUDFLARE_API_TOKEN_FFC: ${{ secrets.FFC_CLOUDFLARE_API_TOKEN_ZONE_AND_DNS }}
          CLOUDFLARE_API_TOKEN_CM: ${{ secrets.CM_CLOUDFLARE_API_TOKEN_ZONE_AND_DNS }}
        run: |
          $ErrorActionPreference = 'Stop'
          $domain = "${{ inputs.domain }}"

          $outDir = Join-Path $env:RUNNER_TEMP 'domain-status-cloudflare'
          New-Item -ItemType Directory -Force -Path $outDir | Out-Null

          $audit = & pwsh -NoProfile -File .\Update-CloudflareDns.ps1 -Zone $domain -Audit *>&1
          $auditPath = Join-Path $outDir 'cloudflare-audit.txt'
          $audit | Out-File -FilePath $auditPath -Encoding utf8

          $dry = & pwsh -NoProfile -File .\Update-CloudflareDns.ps1 -Zone $domain -EnforceStandard -DryRun *>&1
          $dryPath = Join-Path $outDir 'cloudflare-dryrun.txt'
          $dry | Out-File -FilePath $dryPath -Encoding utf8

          "out_dir=$outDir" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Summarize Cloudflare results
        id: summary
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $dir = "${{ steps.run.outputs.out_dir }}"

          $auditLinesRaw = @(Get-Content -Path (Join-Path $dir 'cloudflare-audit.txt') -ErrorAction Stop)
          $auditLines = @($auditLinesRaw | ForEach-Object { $_ -replace "\x1b\[[0-9;]*m", '' })
          $issues = @($auditLines | Where-Object { $_ -match '^(?:WARNING:\s*)?\[(?:MISSING|MISSING/PARTIAL|DIFFERS)\]' })
          $severe = @($auditLines | Where-Object { $_ -match '^(?:WARNING:\s*)?\[(?:MISSING|DIFFERS)\]' })

          $dryLines = @(Get-Content -Path (Join-Path $dir 'cloudflare-dryrun.txt') -ErrorAction Stop)
          $changes = @($dryLines | Where-Object { $_ -match '^[[]DRY-RUN[]]' })

          "issues_count=$($issues.Count)" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "severe_issues_count=$($severe.Count)" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "changes_count=$($changes.Count)" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Upload Cloudflare outputs
        uses: actions/upload-artifact@v4
        with:
          name: cloudflare-domain-status
          path: ${{ steps.run.outputs.out_dir }}/*.txt
          if-no-files-found: error

  m365:
    runs-on: windows-latest
    environment: m365-prod

    outputs:
      domain_exists: ${{ steps.graph.outputs.domain_exists }}
      is_verified: ${{ steps.graph.outputs.is_verified }}
      supports_email: ${{ steps.graph.outputs.supports_email }}

    steps:
      - uses: actions/checkout@v4

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.FFC_AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.FFC_AZURE_TENANT_ID }}
          allow-no-subscriptions: true

      - name: M365 domain status (Graph summary)
        id: graph
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $domain = "${{ inputs.domain }}"

          $token = (az account get-access-token --resource-type ms-graph --query accessToken -o tsv)
          if ([string]::IsNullOrWhiteSpace($token)) { throw 'Failed to acquire Microsoft Graph access token' }

          $encoded = [Uri]::EscapeDataString($domain)
          $uri = "https://graph.microsoft.com/v1.0/domains/$encoded`?$select=id,isVerified,supportedServices"
          $headers = @{ Authorization = "Bearer $token" }

          $exists = $true
          $d = $null
          try {
            $d = Invoke-RestMethod -Method Get -Uri $uri -Headers $headers -ErrorAction Stop
          } catch {
            $resp = $_.Exception.Response
            if ($resp -and $resp.StatusCode -and ([int]$resp.StatusCode -eq 404)) {
              $exists = $false
            } else {
              throw
            }
          }

          $supportsEmail = $false
          if ($d -and $d.supportedServices) {
            $supportsEmail = @($d.supportedServices) -contains 'Email'
          }

          "domain_exists=$exists" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "is_verified=$(if ($d) { $d.isVerified } else { '' })" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "supports_email=$supportsEmail" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Run repo M365 preflight (read-only)
        id: preflight
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $domain = "${{ inputs.domain }}"

          $token = (az account get-access-token --resource-type ms-graph --query accessToken -o tsv)
          if ([string]::IsNullOrWhiteSpace($token)) { throw 'Failed to acquire Microsoft Graph access token' }

          $outDir = Join-Path $env:RUNNER_TEMP 'domain-status-m365'
          New-Item -ItemType Directory -Force -Path $outDir | Out-Null

          $pre = & pwsh -NoProfile -File .\scripts\m365-domain-preflight.ps1 -Domain $domain -SkipCloudflare *>&1
          $preExit = $LASTEXITCODE
          $prePath = Join-Path $outDir 'm365-preflight.txt'
          $pre | Out-File -FilePath $prePath -Encoding utf8
          if ($preExit -ne 0) {
            Write-Warning "m365-domain-preflight.ps1 exited with code $preExit (output saved to $prePath)"
          }

          # Include Graph-provided DNS guidance so Step 1 output contains exact expected values.
          $dns = & pwsh -NoProfile -File .\scripts\m365-domain-status.ps1 -Domain $domain -AccessToken $token -ShowDnsRecords *>&1
          $dnsExit = $LASTEXITCODE
          $dnsPath = Join-Path $outDir 'm365-dns-guidance.txt'
          $dns | Out-File -FilePath $dnsPath -Encoding utf8
          if ($dnsExit -ne 0) {
            Write-Warning "m365-domain-status.ps1 exited with code $dnsExit (output saved to $dnsPath)"
          }

          "out_dir=$outDir" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

          exit 0

      - name: Upload M365 outputs
        uses: actions/upload-artifact@v4
        with:
          name: m365-domain-status
          path: ${{ steps.preflight.outputs.out_dir }}/*.txt
          if-no-files-found: error

  summary:
    runs-on: ubuntu-latest
    needs: [cloudflare, m365]

    steps:
      - name: Download Cloudflare artifacts
        uses: actions/download-artifact@v4
        with:
          name: cloudflare-domain-status
          path: artifacts/cloudflare

      - name: Download M365 artifacts
        uses: actions/download-artifact@v4
        with:
          name: m365-domain-status
          path: artifacts/m365

      - name: Build deterministic summary
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          $domain = "${{ inputs.domain }}"

          $cfIssues = [int]"${{ needs.cloudflare.outputs.issues_count }}"
          $cfSevere = [int]"${{ needs.cloudflare.outputs.severe_issues_count }}"
          $cfChanges = [int]"${{ needs.cloudflare.outputs.changes_count }}"

          $m365Exists = "${{ needs.m365.outputs.domain_exists }}"
          $m365Verified = "${{ needs.m365.outputs.is_verified }}"
          $m365Email = "${{ needs.m365.outputs.supports_email }}"

          $m365ExistsBool = ($m365Exists -eq 'True' -or $m365Exists -eq 'true')
          $m365VerifiedBool = ($m365Verified -eq 'True' -or $m365Verified -eq 'true')
          $m365EmailBool = ($m365Email -eq 'True' -or $m365Email -eq 'true')

          $m365Status = if (-not $m365ExistsBool) { 'FAIL' } elseif ($m365VerifiedBool) { 'PASS' } else { 'PARTIAL' }
          $cfStatus = if ($cfIssues -eq 0) { 'PASS' } elseif ($cfSevere -gt 0) { 'FAIL' } else { 'PARTIAL' }
          $overall = if ($m365Status -eq 'PASS' -and $cfStatus -eq 'PASS') { 'PASS' } elseif ($m365Status -eq 'FAIL') { 'FAIL' } else { 'PARTIAL' }

          $auditPath = 'artifacts/cloudflare/cloudflare-audit.txt'
          $dryPath = 'artifacts/cloudflare/cloudflare-dryrun.txt'
          $dnsPath = 'artifacts/m365/m365-dns-guidance.txt'

          $auditLinesRaw = if (Test-Path $auditPath) { @(Get-Content -Path $auditPath) } else { @() }
          $auditLines = @($auditLinesRaw | ForEach-Object { $_ -replace "\x1b\[[0-9;]*m", '' })
          $dryLines = if (Test-Path $dryPath) { @(Get-Content -Path $dryPath) } else { @() }

          function Get-IssueLevel {
            param(
              [Parameter(Mandatory)] [string[]] $Lines,
              [Parameter(Mandatory)] [string] $MatchText
            )
            $hits = @($Lines | Where-Object { $_ -match '^(?:WARNING:\s*)?\[(?:MISSING|MISSING/PARTIAL|DIFFERS)\]' -and $_ -like "*$MatchText*" })
            if ($hits.Count -eq 0) { return $null }
            if ($hits | Where-Object { $_ -match '^(?:WARNING:\s*)?\[(?:MISSING|DIFFERS)\]' }) { return 'FAIL' }
            return 'PARTIAL'
          }

          function Get-CheckStatus {
            param(
              [Parameter(Mandatory)] [string] $Name,
              [Parameter(Mandatory)] [string] $OkMatch,
              [Parameter(Mandatory)] [string] $IssueMatch
            )

            $okRegex = [regex]::Escape($OkMatch)
            if ($auditLines | Where-Object { $_ -match $okRegex }) {
              return @{ Name = $Name; Status = 'PASS' }
            }

            $issueLevel = Get-IssueLevel -Lines $auditLines -MatchText $IssueMatch
            if ($issueLevel) {
              return @{ Name = $Name; Status = $issueLevel }
            }

            return @{ Name = $Name; Status = 'UNKNOWN' }
          }

          $checks = @()
          $checks += @{ Name = 'M365: domain exists in tenant'; Status = $(if ($m365ExistsBool) { 'PASS' } else { 'FAIL' }) }
          $checks += @{ Name = 'M365: domain verified'; Status = $(if (-not $m365ExistsBool) { 'FAIL' } elseif ($m365VerifiedBool) { 'PASS' } else { 'PARTIAL' }) }
          $checks += @{ Name = 'M365: supports email'; Status = $(if (-not $m365ExistsBool) { 'FAIL' } elseif ($m365EmailBool) { 'PASS' } else { 'PARTIAL' }) }

          $checks += (Get-CheckStatus -Name 'Cloudflare: CNAME autodiscover' -OkMatch 'Required CNAME present: autodiscover.' -IssueMatch 'autodiscover.')
          $checks += (Get-CheckStatus -Name 'Cloudflare: CNAME enterpriseenrollment' -OkMatch 'Required CNAME present: enterpriseenrollment.' -IssueMatch 'enterpriseenrollment.')
          $checks += (Get-CheckStatus -Name 'Cloudflare: CNAME enterpriseregistration' -OkMatch 'Required CNAME present: enterpriseregistration.' -IssueMatch 'enterpriseregistration.')
          $checks += (Get-CheckStatus -Name 'Cloudflare: CNAME lyncdiscover' -OkMatch 'Required CNAME present: lyncdiscover.' -IssueMatch 'lyncdiscover.')
          $checks += (Get-CheckStatus -Name 'Cloudflare: CNAME sip' -OkMatch 'Required CNAME present: sip.' -IssueMatch 'Required CNAME present: sip.')
          $checks += (Get-CheckStatus -Name 'Cloudflare: CNAME www' -OkMatch 'Required CNAME present: www.' -IssueMatch 'WWW CNAME')

          $checks += (Get-CheckStatus -Name 'Cloudflare: SRV _sip._tls' -OkMatch 'Required SRV present: _sip._tls.' -IssueMatch '_sip._tls.')
          $checks += (Get-CheckStatus -Name 'Cloudflare: SRV _sipfederationtls._tcp' -OkMatch 'Required SRV present: _sipfederationtls._tcp.' -IssueMatch '_sipfederationtls._tcp.')
          $checks += (Get-CheckStatus -Name 'Cloudflare: MX (M365) present' -OkMatch 'M365 MX Record found' -IssueMatch 'M365 MX')
          $checks += (Get-CheckStatus -Name 'Cloudflare: SPF (M365) present' -OkMatch 'M365 SPF Record found' -IssueMatch 'M365 SPF')
          $checks += (Get-CheckStatus -Name 'Cloudflare: DMARC present' -OkMatch 'DMARC Record found' -IssueMatch 'DMARC')

          # GitHub Pages apex records are reported as a combined check.
          $ghA = Get-IssueLevel -Lines $auditLines -MatchText 'GitHub Pages A Records'
          $ghAAAA = Get-IssueLevel -Lines $auditLines -MatchText 'GitHub Pages AAAA Records'
          $checks += @{ Name = 'Cloudflare: GitHub Pages apex A records'; Status = ($ghA ?? 'PASS'); Details = '' }
          $checks += @{ Name = 'Cloudflare: GitHub Pages apex AAAA records'; Status = ($ghAAAA ?? 'PASS'); Details = '' }

          $plannedChanges = @($dryLines | Where-Object { $_ -match '^[[]DRY-RUN[]]' })

          $summary = @()
          $summary += "# Domain status: $domain"
          $summary += ''
          $summary += "- Overall: **$overall**"
          $summary += "- Cloudflare: **$cfStatus** ($cfIssues audit issues; $cfSevere severe; $cfChanges planned changes)"
          $summary += "- M365: **$m365Status** (exists=$m365ExistsBool, verified=$m365VerifiedBool, supportsEmail=$m365EmailBool)"
          $summary += ''
          $summary += '## Checks'
          $summary += '| Check | Status |'
          $summary += '| --- | --- |'
          foreach ($c in $checks) {
            $summary += "| $($c.Name) | **$($c.Status)** |"
          }

          $summary += ''
          $summary += '## Planned changes (if you run Enforce)'
          if ($plannedChanges.Count -eq 0) {
            $summary += '- None (dry-run shows no changes).'
          } else {
            foreach ($line in $plannedChanges) {
              $summary += "- $line"
            }
          }

          $summary += ''
          $summary += '## Details (raw outputs)'
          if (Test-Path $auditPath) {
            $summary += '<details><summary>Cloudflare audit</summary>'
            $summary += ''
            $summary += '```'
            $summary += (Get-Content -Path $auditPath -Raw).Trim()
            $summary += '```'
            $summary += '</details>'
          }

          if (Test-Path $dryPath) {
            $summary += ''
            $summary += '<details><summary>Cloudflare dry-run</summary>'
            $summary += ''
            $summary += '```'
            $summary += (Get-Content -Path $dryPath -Raw).Trim()
            $summary += '```'
            $summary += '</details>'
          }

          if (Test-Path $dnsPath) {
            $summary += ''
            $summary += '<details><summary>M365 DNS guidance (Graph)</summary>'
            $summary += ''
            $summary += '```'
            $summary += (Get-Content -Path $dnsPath -Raw).Trim()
            $summary += '```'
            $summary += '</details>'
          }

          ($summary -join "`n") | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8

  post_back:
    runs-on: ubuntu-latest
    needs: [cloudflare, m365]
    if: ${{ inputs.issue_number != '' && inputs.issue_number != 0 }}

    steps:
      - name: Download Cloudflare artifacts
        uses: actions/download-artifact@v4
        with:
          name: cloudflare-domain-status
          path: artifacts/cloudflare

      - name: Download M365 artifacts
        uses: actions/download-artifact@v4
        with:
          name: m365-domain-status
          path: artifacts/m365

      - name: Comment results back to issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            const issueNumber = Number('${{ inputs.issue_number }}');
            const domain = '${{ inputs.domain }}';

            const cfIssues = Number('${{ needs.cloudflare.outputs.issues_count }}');
            const cfSevere = Number('${{ needs.cloudflare.outputs.severe_issues_count }}');
            const cfChanges = Number('${{ needs.cloudflare.outputs.changes_count }}');

            const m365Exists = String('${{ needs.m365.outputs.domain_exists }}');
            const m365Verified = String('${{ needs.m365.outputs.is_verified }}');
            const m365Email = String('${{ needs.m365.outputs.supports_email }}');

            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            const m365Status = (m365Exists === 'True' || m365Exists === 'true')
              ? ((m365Verified === 'True' || m365Verified === 'true') ? 'PASS' : 'PARTIAL')
              : 'FAIL';

            const cfStatus = (cfIssues === 0) ? 'PASS' : ((cfSevere > 0) ? 'FAIL' : 'PARTIAL');

            const overall = (m365Status === 'PASS' && cfStatus === 'PASS')
              ? 'PASS'
              : ((m365Status === 'FAIL') ? 'FAIL' : 'PARTIAL');

            const cfAudit = fs.readFileSync('artifacts/cloudflare/cloudflare-audit.txt', 'utf8');
            const cfDryRun = fs.readFileSync('artifacts/cloudflare/cloudflare-dryrun.txt', 'utf8');
            const m365Preflight = fs.readFileSync('artifacts/m365/m365-preflight.txt', 'utf8');

            const body = [
              `Domain status for **${domain}**`,
              '',
              `- Overall: **${overall}**`,
              `- Cloudflare: **${cfStatus}** (${cfIssues} audit issues; ${cfSevere} severe; ${cfChanges} planned changes)`,
              `- M365: **${m365Status}** (exists=${m365Exists}, verified=${m365Verified}, supportsEmail=${m365Email})`,
              `- Run: ${runUrl}`,
              '',
              '<details><summary>Cloudflare audit</summary>\n\n```\n' + cfAudit.trim() + '\n```\n</details>',
              '',
              '<details><summary>Cloudflare dry-run preview (what will change)</summary>\n\n```\n' + cfDryRun.trim() + '\n```\n</details>',
              '',
              '<details><summary>M365 preflight (read-only)</summary>\n\n```\n' + m365Preflight.trim() + '\n```\n</details>',
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body,
            });
