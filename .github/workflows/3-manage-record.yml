name: '03. DNS - Manage Record (Manual / Issue Label)'
run-name:
  'Manage Record: ${{ inputs.domain }} (${{ inputs.record_type }} ${{ inputs.record_name }})'
on:
  workflow_dispatch:
    inputs:
      domain:
        description: 'Domain Name (Zone)'
        required: true
        type: string
      dry_run:
        description: 'Dry Run (No changes)'
        type: boolean
        default: true
      record_type:
        description: 'Record Type'
        type: choice
        options:
          - TXT
          - A
          - CNAME
          - MX
        default: TXT
      record_name:
        description: 'Record Name (@ or subdomain)'
        type: string
        default: '@'
      record_content:
        description: 'Record Content'
        type: string
        default: 'v=spf1 include:spf.protection.outlook.com -all'
  issues:
    types: [labeled]

permissions:
  contents: read
  issues: read
  actions: read

jobs:
  resolve-context:
    runs-on: ubuntu-latest
    outputs:
      domain: ${{ steps.parse.outputs.domain }}
      dry_run: ${{ steps.parse.outputs.dry_run }}
      source: ${{ steps.parse.outputs.source }}
      skip: ${{ steps.parse.outputs.skip }}
    steps:
      - name: Parse Input Source
        id: parse
        uses: actions/github-script@v8
        with:
          script: |
            let domain = '';
            let dry_run = 'true';
            let source = 'unknown';
            let skip = 'false';

            // CASE 1: Manual Trigger (workflow_dispatch)
            if (context.eventName === 'workflow_dispatch') {
              domain = context.payload.inputs.domain;
              dry_run = context.payload.inputs.dry_run;
              source = 'manual';
              console.log(`[Manual] Domain provided: ${domain}, DryRun: ${dry_run}`);
            } 

            // CASE 2: Issue Trigger
            else if (context.eventName === 'issues') {
              // Only proceed when an explicit label is applied.
              // GitHub Actions can't filter issue triggers by label name, so we gate here.
              const requiredLabel = 'run-dns-manage-record';
              const appliedLabel = context.payload.label?.name || '';
              if (appliedLabel !== requiredLabel) {
                core.notice(`Issue label '${appliedLabel}' does not match required label '${requiredLabel}'. Skipping.`);
                skip = 'true';
                core.setOutput('domain', '');
                core.setOutput('dry_run', dry_run);
                core.setOutput('source', 'issue');
                core.setOutput('skip', skip);
                return;
              }

              const body = context.payload.issue.body || '';
              source = 'issue';
              
              // Simple regex to find "Domain Name" followed by the user's input
              // Matches: "### Domain Name\n\nexample.org" or "Domain Name: example.org"
              const domainRegex = /### Domain Name\s+([a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/;
              const match = body.match(domainRegex);
              
              if (match && match[1]) {
                domain = match[1].trim();
                console.log(`[Issue] Extracted domain: ${domain}`);
              } else {
                console.log('[Issue] Could not find "### Domain Name" in issue body.');
              }
              
              // For safety, issue ops always default to DryRun until explicitly approved
              // You might change this logic later to check labels like "approved"
            }

            if (!domain) {
              core.setFailed('Could not determine Domain Name from input or issue body.');
              return;
            }

            core.setOutput('domain', domain);
            core.setOutput('dry_run', dry_run);
            core.setOutput('source', source);
            core.setOutput('skip', skip);

  validate-zone:
    needs: resolve-context
    runs-on: windows-latest # Using Windows runner for PowerShell script
    environment: cloudflare-prod
    if: needs.resolve-context.outputs.skip != 'true'
    env:
      CLOUDFLARE_API_TOKEN_FFC: ${{ secrets.FFC_CLOUDFLARE_API_TOKEN_ZONE_AND_DNS }}
      CLOUDFLARE_API_TOKEN_CM: ${{ secrets.CM_CLOUDFLARE_API_TOKEN_ZONE_AND_DNS }}
    steps:
      - uses: actions/checkout@v4

      - name: Validate Zone in Cloudflare
        shell: pwsh
        run: |
          $Domain = "${{ needs.resolve-context.outputs.domain }}"
          Write-Host "Checking if zone '$Domain' exists in Cloudflare..."

          .\Update-CloudflareDns.ps1 -Zone $Domain -List -ErrorAction SilentlyContinue

          if ($LASTEXITCODE -eq 0) {
            Write-Host "SUCCESS: Zone '$Domain' found and accessible." -ForegroundColor Green
          } else {
            Write-Warning "FAILURE: Zone '$Domain' not found or token lacks permission."
            # We don't exit 1 here yet because 'Purchase New Domain' workflow might *expect* it to be missing.
          }

  add-test-record:
    needs: resolve-context
    runs-on: windows-latest
    environment: cloudflare-prod
    if:
      needs.resolve-context.outputs.skip != 'true' && needs.resolve-context.outputs.dry_run ==
      'false'
    env:
      CLOUDFLARE_API_TOKEN_FFC: ${{ secrets.FFC_CLOUDFLARE_API_TOKEN_ZONE_AND_DNS }}
      CLOUDFLARE_API_TOKEN_CM: ${{ secrets.CM_CLOUDFLARE_API_TOKEN_ZONE_AND_DNS }}
    steps:
      - uses: actions/checkout@v4

      - name: Manage DNS Record
        shell: pwsh
        run: |
          $Domain  = "${{ needs.resolve-context.outputs.domain }}"
          $Type    = "${{ github.event.inputs.record_type || 'TXT' }}"
          $Name    = "${{ github.event.inputs.record_name || '@' }}"
          $Content = "${{ github.event.inputs.record_content || 'v=spf1 include:spf.protection.outlook.com -all' }}"

          Write-Host "Managing $Type record for $Name in zone $Domain..."

          .\Update-CloudflareDns.ps1 -Zone $Domain `
            -Name $Name `
            -Type $Type `
            -Content $Content `
            -Ttl 1
            
          if ($LASTEXITCODE -eq 0) {
            Write-Host "SUCCESS: DNS operation completed." -ForegroundColor Green
          } else {
            Write-Error "FAILURE: Operation failed."
            exit 1
          }

      - name: Post-Change Compliance Audit
        shell: pwsh
        run: |
          $Domain = "${{ needs.resolve-context.outputs.domain }}"
          Write-Host "--- Running Compliance Audit ---"
          .\Update-CloudflareDns.ps1 -Zone $Domain -Audit -ErrorAction Continue
