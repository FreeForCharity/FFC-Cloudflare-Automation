name: '91. Repo - CI Validate and Test'

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  validate:
    name: Validate Repository
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup Go (for actionlint)
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'

      - name: Install actionlint
        run: go install github.com/rhysd/actionlint/cmd/actionlint@latest

      - name: Lint GitHub Actions workflows
        run: '"$(go env GOPATH)/bin/actionlint" -color'

      - name: Setup Node (for Prettier)
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'

      - name: Check formatting (Prettier)
        run: |
          npx --yes prettier@3.3.3 --check . --ignore-unknown

      - name: Validate PowerShell scripts
        shell: pwsh
        run: |
          Write-Host "Validating PowerShell scripts..."
          $scripts = @(
            'Update-CloudflareDns.ps1',
            'Update-StagingDns.ps1',
            'Export-CloudflareDns.ps1'
          )
          $hasErrors = $false
          foreach ($script in $scripts) {
            if (Test-Path $script) {
              Write-Host "Checking $script..." -NoNewline
              try {
                $errors = $null
                [void][System.Management.Automation.Language.Parser]::ParseInput(
                  (Get-Content $script -Raw),
                  [ref]$null,
                  [ref]$errors
                )
                if ($errors -and $errors.Count -gt 0) {
                  $messages = $errors | ForEach-Object { $_.Message } | Where-Object { $_ } | Select-Object -Unique
                  throw "Syntax errors in '$script': $($messages -join '; ')"
                }
                Write-Host " OK" -ForegroundColor Green
              } catch {
                Write-Host " FAILED" -ForegroundColor Red
                Write-Error $_.Exception.Message
                $hasErrors = $true
              }
            } else {
              Write-Error "Script not found: $script"
              $hasErrors = $true
            }
          }
          if ($hasErrors) {
            exit 1
          }

      - name: Install PSScriptAnalyzer
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          Set-PSRepository -Name PSGallery -InstallationPolicy Trusted
          Install-Module PSScriptAnalyzer -Scope CurrentUser -Force -AllowClobber

      - name: Lint PowerShell (PSScriptAnalyzer)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          Import-Module PSScriptAnalyzer
          $results = Invoke-ScriptAnalyzer -Path . -Recurse -Severity @('Error','Warning') | Where-Object { $_.ScriptPath -like '*.ps1' }
          $errors = $results | Where-Object { $_.Severity -eq 'Error' }
          $warnings = $results | Where-Object { $_.Severity -eq 'Warning' }

          if ($warnings) {
            Write-Host "PSScriptAnalyzer warnings:" -ForegroundColor Yellow
            $warnings | Select-Object RuleName,Severity,Message,Line | Format-Table -AutoSize | Out-String | Write-Host
          }

          if ($errors) {
            Write-Host "PSScriptAnalyzer errors:" -ForegroundColor Red
            $errors | Select-Object RuleName,Severity,Message,Line | Format-Table -AutoSize | Out-String | Write-Host
            throw "PSScriptAnalyzer found $($errors.Count) error(s)."
          }

      - name: Check PowerShell formatting (Invoke-Formatter)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          Import-Module PSScriptAnalyzer

          $excludePattern = '([/\\]node_modules[/\\]|[/\\]\.git[/\\]|[/\\]\.venv[/\\])'
          $files = Get-ChildItem -Path . -Filter *.ps1 -File -Recurse | Where-Object { $_.FullName -notmatch $excludePattern }
          if (-not $files -or $files.Count -eq 0) {
            Write-Host "No .ps1 files found."
            exit 0
          }

          $changed = @()
          foreach ($file in $files) {
            $original = Get-Content -Path $file.FullName -Raw
            $formatted = Invoke-Formatter -ScriptDefinition $original
            if ($formatted -ne $original) {
              $changed += $file.FullName
            }
          }

          if ($changed.Count -gt 0) {
            Write-Host "PowerShell formatting differs for:" -ForegroundColor Red
            $changed | ForEach-Object { Write-Host " - $_" }
            throw "Invoke-Formatter check failed. Run Invoke-Formatter locally to update files."
          }

      - name: Check for sensitive files
        run: |
          echo "Checking for accidentally committed sensitive files..."

          found_sensitive=false

          # Check for sensitive patterns
          sensitive_patterns=(
            "*.pem"
            "*.key"
            ".env"
            ".env.local"
          )

          for pattern in "${sensitive_patterns[@]}"; do
            if find . -name "$pattern" -not -path "./.git/*" | grep -q .; then
              echo "ERROR: Found sensitive files matching pattern: $pattern"
              find . -name "$pattern" -not -path "./.git/*"
              found_sensitive=true
            fi
          done

          if [ "$found_sensitive" = true ]; then
            echo "ERROR: Sensitive files found in repository!"
            exit 1
          fi
          echo "✓ No sensitive files found"

      - name: Verify README exists
        run: |
          if [ ! -f "README.md" ]; then
            echo "Error: README.md not found"
            exit 1
          fi
          echo "✓ README.md exists"
