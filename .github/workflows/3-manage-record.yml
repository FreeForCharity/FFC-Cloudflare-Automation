name: "[DNS] 3. Manual - Manage Record"
run-name: "Manage Record: ${{ inputs.domain }} (${{ inputs.record_type }} ${{ inputs.record_name }})"
on:
  workflow_dispatch:
    inputs:
      domain:
        description: 'Domain Name (Zone)'
        required: true
        type: string
      dry_run:
        description: 'Dry Run (No changes)'
        type: boolean
        default: true
      record_type:
        description: 'Record Type'
        type: choice
        options:
          - TXT
          - A
          - CNAME
          - MX
        default: TXT
      record_name:
        description: 'Record Name (@ or subdomain)'
        type: string
        default: '@'
      record_content:
        description: 'Record Content'
        type: string
        default: 'v=spf1 include:spf.protection.outlook.com -all'
  issues:
    types: [opened, edited, labeled]

permissions:
  contents: read
  issues: read
  actions: read

jobs:
  resolve-context:
    runs-on: ubuntu-latest
    outputs:
      domain: ${{ steps.parse.outputs.domain }}
      dry_run: ${{ steps.parse.outputs.dry_run }}
      source: ${{ steps.parse.outputs.source }}
    steps:
      - name: Parse Input Source
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            let domain = '';
            let dry_run = 'true';
            let source = 'unknown';

            // CASE 1: Manual Trigger (workflow_dispatch)
            if (context.eventName === 'workflow_dispatch') {
              domain = context.payload.inputs.domain;
              dry_run = context.payload.inputs.dry_run;
              source = 'manual';
              console.log(`[Manual] Domain provided: ${domain}, DryRun: ${dry_run}`);
            } 
            
            // CASE 2: Issue Trigger
            else if (context.eventName === 'issues') {
              const body = context.payload.issue.body || '';
              source = 'issue';
              
              // Simple regex to find "Domain Name" followed by the user's input
              // Matches: "### Domain Name\n\nexample.org" or "Domain Name: example.org"
              const domainRegex = /### Domain Name\s+([a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/;
              const match = body.match(domainRegex);
              
              if (match && match[1]) {
                domain = match[1].trim();
                console.log(`[Issue] Extracted domain: ${domain}`);
              } else {
                console.log('[Issue] Could not find "### Domain Name" in issue body.');
              }
              
              // For safety, issue ops always default to DryRun until explicitly approved
              // You might change this logic later to check labels like "approved"
            }

            if (!domain) {
              core.setFailed('Could not determine Domain Name from input or issue body.');
              return;
            }

            core.setOutput('domain', domain);
            core.setOutput('dry_run', dry_run);
            core.setOutput('source', source);

  validate-zone:
    needs: resolve-context
    runs-on: ubuntu-latest
    environment: cloudflare-prod
    env:
      CLOUDFLARE_API_KEY_DNS_ONLY: ${{ secrets.CLOUDFLARE_API_KEY_DNS_ONLY }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt
      
      - name: Validate Zone in Cloudflare
        run: |
          DOMAIN="${{ needs.resolve-context.outputs.domain }}"
          echo "Checking if zone '$DOMAIN' exists in Cloudflare..."
          
          # Try to list records (will fail if zone doesn't exist)
          python update_dns.py --zone "$DOMAIN" --name "@" --type A --search || {
            echo "WARNING: Zone '$DOMAIN' not found or token lacks permission."
          }

  add-test-record:
    needs: resolve-context
    runs-on: ubuntu-latest
    environment: cloudflare-prod
    if: needs.resolve-context.outputs.dry_run == 'false'
    env:
      CLOUDFLARE_API_KEY_DNS_ONLY: ${{ secrets.CLOUDFLARE_API_KEY_DNS_ONLY }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt
      
      - name: Manage DNS Record
        run: |
          DOMAIN="${{ needs.resolve-context.outputs.domain }}"
          TYPE="${{ github.event.inputs.record_type || 'TXT' }}"
          NAME="${{ github.event.inputs.record_name || '@' }}"
          CONTENT="${{ github.event.inputs.record_content || 'v=spf1 include:spf.protection.outlook.com -all' }}"
          
          echo "Managing $TYPE record for $NAME in zone $DOMAIN..."
          
          python update_dns.py --zone "$DOMAIN" \
            --name "$NAME" \
            --type "$TYPE" \
            --content "$CONTENT"
            
          if [ $? -eq 0 ]; then
            echo "SUCCESS: DNS operation completed."
          else
            echo "FAILURE: Operation failed."
            exit 1
          fi

      - name: Post-Change Compliance Audit
        run: |
          DOMAIN="${{ needs.resolve-context.outputs.domain }}"
          echo "--- Running Compliance Audit ---"
          python audit_compliance.py --zone "$DOMAIN" || true
