name: DNS Update Direct

on:
  workflow_dispatch:
    inputs:
      domain:
        description: Root domain to update (e.g., example.org)
        required: true
        type: string
      pages_host:
        description: GitHub Pages hostname (e.g., freeforcharity.github.io)
        required: true
        type: string
      mode:
        description: Update mode
        required: true
        type: choice
        options:
          - github-pages-a-aaaa
          - apex-cname
          - revert-apex-a
      apex_a:
        description: IPv4 for revert-apex-a mode (e.g., 204.44.192.77)
        required: false
        type: string
      purge:
        description: Purge other A/CNAME (keep apex/www/staging)
        required: false
        type: boolean
      apply:
        description: Apply changes (default: dry-run)
        required: false
        type: boolean
        default: false

jobs:
  update:
    runs-on: ubuntu-latest
    environment: cloudflare-prod
    concurrency:
      group: dns-update-${{ inputs.domain }}
      cancel-in-progress: true
    env:
      CLOUDFLARE_API_KEY_DNS_ONLY: ${{ secrets.CLOUDFLARE_API_KEY_DNS_ONLY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Guard: allowed actors
        run: |
          if [ -n "${{ vars.ALLOWED_ACTORS }}" ]; then
            IFS=',' read -ra USERS <<< "${{ vars.ALLOWED_ACTORS }}"
            OK=false
            for u in "${USERS[@]}"; do
              if [ "$u" = "${{ github.actor }}" ]; then OK=true; fi
            done
            if [ "$OK" != "true" ]; then
              echo "Actor ${{ github.actor }} is not allowed to run this workflow."; exit 1
            fi
          else
            echo "No ALLOWED_ACTORS repo variable set; skipping actor guard."
          fi

      - name: Guard: apply only on main
        if: ${{ inputs.apply == true && github.ref != 'refs/heads/main' }}
        run: |
          echo "Apply runs are restricted to main. Current ref: ${{ github.ref }}"; exit 1

      - name: Update GitHub Pages with A+AAAA
        if: ${{ inputs.mode == 'github-pages-a-aaaa' }}
        run: |
          CMD="python update_pages_dns.py --domain \"${{ inputs.domain }}\" --pages-host \"${{ inputs.pages_host }}\" --set-github-a --set-github-aaaa"
          if [ "${{ inputs.purge }}" = "true" ]; then CMD="$CMD --purge-a-and-cname"; fi
          if [ "${{ inputs.apply }}" != "true" ]; then CMD="$CMD --dry-run"; fi
          echo "$CMD"
          eval "$CMD"

      - name: Set apex CNAME (flattening)
        if: ${{ inputs.mode == 'apex-cname' }}
        run: |
          CMD="python update_pages_dns.py --domain \"${{ inputs.domain }}\" --pages-host \"${{ inputs.pages_host }}\" --set-apex-cname"
          if [ "${{ inputs.apply }}" != "true" ]; then CMD="$CMD --dry-run"; fi
          echo "$CMD"
          eval "$CMD"

      - name: Revert apex to IPv4
        if: ${{ inputs.mode == 'revert-apex-a' }}
        run: |
          CMD="python update_pages_dns.py --domain \"${{ inputs.domain }}\" --set-apex-a \"${{ inputs.apex_a }}\" --clear-apex-aaaa --set-www-cname \"${{ inputs.domain }}\""
          if [ "${{ inputs.apply }}" != "true" ]; then CMD="$CMD --dry-run"; fi
          echo "$CMD"
          eval "$CMD"

      - name: Summary
        run: |
          echo "DNS update completed for ${{ inputs.domain }}"