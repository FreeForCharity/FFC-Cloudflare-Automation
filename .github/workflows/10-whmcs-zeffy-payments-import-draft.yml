name: '10. WHMCS -> Zeffy Payments Import (Draft)'
run-name: 'WHMCS -> Zeffy Import Draft'

on:
  workflow_dispatch:
    inputs:
      api_url:
        description: 'WHMCS API endpoint (e.g., https://freeforcharity.org/hub/includes/api.php)'
        required: false
        type: string
        default: 'https://freeforcharity.org/hub/includes/api.php'
      clients_output:
        description: 'WHMCS clients CSV output path'
        required: false
        type: string
        default: 'artifacts/whmcs/whmcs_clients.csv'
      transactions_output:
        description: 'WHMCS transactions CSV output path'
        required: false
        type: string
        default: 'artifacts/whmcs/whmcs_transactions.csv'
      start_date:
        description: 'Optional start date for transactions export (YYYY-MM-DD)'
        required: false
        type: string
        default: ''
      end_date:
        description: 'Optional end date for transactions export (YYYY-MM-DD)'
        required: false
        type: string
        default: ''
      max_rows:
        description: 'Safety cap for number of transactions exported'
        required: false
        type: number
        default: 200000
      zeffy_output:
        description: 'Zeffy draft CSV output path'
        required: false
        type: string
        default: 'artifacts/zeffy/zeffy_payments_import_draft.csv'

permissions:
  contents: read

jobs:
  whmcs_to_zeffy_draft:
    runs-on: windows-latest
    environment: whmcs-prod

    steps:
      - uses: actions/checkout@v4

      - name: Validate required WHMCS secrets
        id: validate_secrets
        shell: pwsh
        env:
          WHMCS_API_SECRET: ${{ secrets.ZBBEPFQ5W7RCSIME0NOQOYRQIDGTKBPU }}
        run: |
          $ErrorActionPreference = 'Stop'

          if ([string]::IsNullOrWhiteSpace($env:WHMCS_API_SECRET)) {
            throw "Missing secret in environment 'whmcs-prod': ZBBEPFQ5W7RCSIME0NOQOYRQIDGTKBPU"
          }

      - name: Export clients (read-only)
        id: export_clients
        shell: pwsh
        env:
          WHMCS_API_URL: ${{ inputs.api_url }}
          WHMCS_API_IDENTIFIER: 'zbBEpfq5W7RCSImE0NOqoYrqIDGTkBPu'
          WHMCS_API_SECRET: ${{ secrets.ZBBEPFQ5W7RCSIME0NOQOYRQIDGTKBPU }}
          WHMCS_API_ACCESS_KEY: ${{ secrets.WHMCS_API_ACCESS_KEY }}
        run: |
          $ErrorActionPreference = 'Stop'

          $out = "${{ inputs.clients_output }}"
          $dir = Split-Path -Parent $out
          if (-not [string]::IsNullOrWhiteSpace($dir)) {
            New-Item -ItemType Directory -Force -Path $dir | Out-Null
          }

          & pwsh -NoProfile -File .\scripts\whmcs-clients-export.ps1 -ApiUrl $env:WHMCS_API_URL -OutputFile $out

          if ($LASTEXITCODE -ne 0) {
            throw "WHMCS clients export failed with exit code $LASTEXITCODE."
          }

          if (-not (Test-Path $out)) {
            throw "Expected output file not found: $out"
          }

      - name: Export transactions (read-only)
        id: export_transactions
        shell: pwsh
        env:
          WHMCS_API_URL: ${{ inputs.api_url }}
          WHMCS_API_IDENTIFIER: 'zbBEpfq5W7RCSImE0NOqoYrqIDGTkBPu'
          WHMCS_API_SECRET: ${{ secrets.ZBBEPFQ5W7RCSIME0NOQOYRQIDGTKBPU }}
          WHMCS_API_ACCESS_KEY: ${{ secrets.WHMCS_API_ACCESS_KEY }}
        run: |
          $ErrorActionPreference = 'Stop'

          $out = "${{ inputs.transactions_output }}"
          $dir = Split-Path -Parent $out
          if (-not [string]::IsNullOrWhiteSpace($dir)) {
            New-Item -ItemType Directory -Force -Path $dir | Out-Null
          }

          $args = @('-NoProfile','-File','.\\scripts\\whmcs-transactions-export.ps1','-ApiUrl',$env:WHMCS_API_URL,'-OutputFile',$out,'-MaxRows','${{ inputs.max_rows }}')

          if (-not [string]::IsNullOrWhiteSpace('${{ inputs.start_date }}')) {
            $args += @('-StartDate','${{ inputs.start_date }}')
          }
          if (-not [string]::IsNullOrWhiteSpace('${{ inputs.end_date }}')) {
            $args += @('-EndDate','${{ inputs.end_date }}')
          }

          & pwsh @args

          if ($LASTEXITCODE -ne 0) {
            throw "WHMCS transactions export failed with exit code $LASTEXITCODE."
          }

          if (-not (Test-Path $out)) {
            throw "Expected output file not found: $out"
          }

      - name: Generate Zeffy payments import draft
        id: generate_zeffy
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          $clients = "${{ inputs.clients_output }}"
          $tx = "${{ inputs.transactions_output }}"
          $out = "${{ inputs.zeffy_output }}"

          $dir = Split-Path -Parent $out
          if (-not [string]::IsNullOrWhiteSpace($dir)) {
            New-Item -ItemType Directory -Force -Path $dir | Out-Null
          }

          & pwsh -NoProfile -File .\scripts\zeffy-payments-import-draft.ps1 -ClientsCsv $clients -TransactionsCsv $tx -OutputFile $out

          if ($LASTEXITCODE -ne 0) {
            throw "Zeffy draft generation failed with exit code $LASTEXITCODE."
          }

          if (-not (Test-Path $out)) {
            throw "Expected output file not found: $out"
          }

      - name: Validate Zeffy CSV headers
        id: validate_zeffy_headers
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          $out = "${{ inputs.zeffy_output }}"
          $clients = "${{ inputs.clients_output }}"
          $tx = "${{ inputs.transactions_output }}"
          $startDate = '${{ inputs.start_date }}'
          $endDate = '${{ inputs.end_date }}'
          $maxRows = '${{ inputs.max_rows }}'

          $expected = 'firstName,lastName,amount,address,city,postalCode,country,type,formTitle,rateTitle,email,language,date (MM/DD/YYYY),state/province,paymentMethod,receiptUrl,ticketUrl,receiptNumber,companyName,note,annotation'
          $actual = (Get-Content -LiteralPath $out -TotalCount 1) -replace '^\uFEFF',''
          $actual = $actual.Trim() -replace '^"','' -replace '"$',''
          $actual = $actual -replace '","',','

          if ($actual -ne $expected) {
            throw "Zeffy CSV header mismatch. Expected: $expected  Actual: $actual"
          }

      - name: Upload WHMCS clients
        id: upload_clients
        uses: actions/upload-artifact@v6
        with:
          name: whmcs_clients
          path: ${{ inputs.clients_output }}
          if-no-files-found: error

      - name: Upload WHMCS transactions
        id: upload_transactions
        uses: actions/upload-artifact@v6
        with:
          name: whmcs_transactions
          path: ${{ inputs.transactions_output }}
          if-no-files-found: error

      - name: Upload Zeffy draft
        id: upload_zeffy
        uses: actions/upload-artifact@v6
        with:
          name: zeffy_payments_import_draft
          path: ${{ inputs.zeffy_output }}
          if-no-files-found: error

      - name: Job summary
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Continue'

          function Format-Outcome {
            param([string]$Outcome)
            if ([string]::IsNullOrWhiteSpace($Outcome)) { return 'unknown' }
            switch ($Outcome.ToLowerInvariant()) {
              'success' { return 'PASS' }
              'failure' { return 'FAIL' }
              'cancelled' { return 'CANCELLED' }
              'skipped' { return 'SKIPPED' }
              default { return $Outcome }
            }
          }

          function Get-DataRowCount {
            param([Parameter(Mandatory=$true)][string]$Path)
            if (-not (Test-Path -LiteralPath $Path)) { return $null }

            $lineCount = 0
            Get-Content -LiteralPath $Path -ReadCount 5000 | ForEach-Object { $lineCount += $_.Count }
            if ($lineCount -le 0) { return 0 }
            return [Math]::Max(0, $lineCount - 1)
          }

          $clients = "${{ inputs.clients_output }}"
          $tx = "${{ inputs.transactions_output }}"
          $out = "${{ inputs.zeffy_output }}"

          $clientsRows = Get-DataRowCount -Path $clients
          $txRows = Get-DataRowCount -Path $tx
          $zeffyRows = Get-DataRowCount -Path $out

          $runUrl = "$($env:GITHUB_SERVER_URL)/$($env:GITHUB_REPOSITORY)/actions/runs/$($env:GITHUB_RUN_ID)"
          $artifactsUrl = "$($env:GITHUB_SERVER_URL)/$($env:GITHUB_REPOSITORY)/actions/runs/$($env:GITHUB_RUN_ID)/artifacts"

          "## Job summary" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8

          "### Status" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          "- Overall job: $(Format-Outcome '${{ job.status }}') (${{ job.status }})" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          "- Validate WHMCS secrets: $(Format-Outcome '${{ steps.validate_secrets.outcome }}')" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          "- Export clients: $(Format-Outcome '${{ steps.export_clients.outcome }}')" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          "- Export transactions: $(Format-Outcome '${{ steps.export_transactions.outcome }}')" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          "- Generate Zeffy CSV: $(Format-Outcome '${{ steps.generate_zeffy.outcome }}')" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          "- Validate Zeffy headers: $(Format-Outcome '${{ steps.validate_zeffy_headers.outcome }}')" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          "- Upload whmcs_clients artifact: $(Format-Outcome '${{ steps.upload_clients.outcome }}')" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          "- Upload whmcs_transactions artifact: $(Format-Outcome '${{ steps.upload_transactions.outcome }}')" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          "- Upload zeffy_payments_import_draft artifact: $(Format-Outcome '${{ steps.upload_zeffy.outcome }}')" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8

          "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          "### Inputs" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          "- api_url: ${{ inputs.api_url }}" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          "- start_date: ${{ inputs.start_date }}" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          "- end_date: ${{ inputs.end_date }}" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          "- max_rows: ${{ inputs.max_rows }}" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8

          "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          "### Outputs" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          "- Clients CSV: $clients (rows: $clientsRows)" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          "- Transactions CSV: $tx (rows: $txRows)" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          "- Zeffy draft CSV: $out (rows: $zeffyRows)" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8

          "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          "### Links" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          "- Run: $runUrl" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          "- Artifacts page: $artifactsUrl" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
