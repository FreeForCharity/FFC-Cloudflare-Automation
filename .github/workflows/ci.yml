name: CI - Validate and Test

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  validate:
    name: Validate Repository
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Validate PowerShell scripts
        shell: pwsh
        run: |
          Write-Host "Validating PowerShell scripts..."
          $scripts = @(
            'Update-CloudflareDns.ps1',
            'Update-StagingDns.ps1',
            'Export-CloudflareDns.ps1'
          )
          $hasErrors = $false
          foreach ($script in $scripts) {
            if (Test-Path $script) {
              Write-Host "Checking $script..." -NoNewline
              try {
                $errors = $null
                [void][System.Management.Automation.Language.Parser]::ParseInput(
                  (Get-Content $script -Raw),
                  [ref]$null,
                  [ref]$errors
                )
                if ($errors -and $errors.Count -gt 0) {
                  $messages = $errors | ForEach-Object { $_.Message } | Where-Object { $_ } | Select-Object -Unique
                  throw "Syntax errors in '$script': $($messages -join '; ')"
                }
                Write-Host " OK" -ForegroundColor Green
              } catch {
                Write-Host " FAILED" -ForegroundColor Red
                Write-Error $_.Exception.Message
                $hasErrors = $true
              }
            } else {
              Write-Error "Script not found: $script"
              $hasErrors = $true
            }
          }
          if ($hasErrors) {
            exit 1
          }

      - name: Check for sensitive files
        run: |
          echo "Checking for accidentally committed sensitive files..."
          
          found_sensitive=false
          
          # Check for sensitive patterns
          sensitive_patterns=(
            "*.pem"
            "*.key"
            ".env"
            ".env.local"
          )
          
          for pattern in "${sensitive_patterns[@]}"; do
            if find . -name "$pattern" -not -path "./.git/*" | grep -q .; then
              echo "ERROR: Found sensitive files matching pattern: $pattern"
              find . -name "$pattern" -not -path "./.git/*"
              found_sensitive=true
            fi
          done
          
          if [ "$found_sensitive" = true ]; then
            echo "ERROR: Sensitive files found in repository!"
            exit 1
          fi
          echo "✓ No sensitive files found"

      - name: Verify README exists
        run: |
          if [ ! -f "README.md" ]; then
            echo "Error: README.md not found"
            exit 1
          fi
          echo "✓ README.md exists"
