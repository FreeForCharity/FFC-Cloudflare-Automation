name: Cloudflare Zone Add

permissions:
  contents: read
  actions: read

on:
  workflow_dispatch:
    inputs:
      domain:
        description: Zone name to add (e.g., example.org)
        required: true
        type: string
      apply:
        description: 'Apply (default: dry-run)'
        required: false
        type: boolean
        default: false

jobs:
  add:
    runs-on: ubuntu-latest
    environment: cloudflare-prod
    concurrency:
      group: zone-add-${{ inputs.domain }}
      cancel-in-progress: true
    env:
      CLOUDFLARE_API_TOKEN_ZONE_CREATE: ${{ secrets.CLOUDFLARE_API_TOKEN_ZONE_CREATE }}
      CLOUDFLARE_ACCOUNT_ID: ${{ vars.CLOUDFLARE_ACCOUNT_ID }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check actor allowlist
        run: |
          if [ -n "${{ vars.ALLOWED_ACTORS }}" ]; then
            IFS=',' read -ra USERS <<< "${{ vars.ALLOWED_ACTORS }}"
            OK=false
            for u in "${USERS[@]}"; do
              if [ "$u" = "${{ github.actor }}" ]; then OK=true; fi
            done
            if [ "$OK" != "true" ]; then
              echo "Actor ${{ github.actor }} is not allowed to run this workflow."; exit 1
            fi
          else
            echo "No ALLOWED_ACTORS repo variable set; skipping actor guard."
          fi

      - name: Guard apply only on main
        if: ${{ inputs.apply == true && github.ref != 'refs/heads/main' }}
        run: |
          echo "Apply runs are restricted to main. Current ref: ${{ github.ref }}"; exit 1

      - name: Resolve account ID
        id: acct
        run: |
          if [ -n "$CLOUDFLARE_ACCOUNT_ID" ]; then
            echo "id=$CLOUDFLARE_ACCOUNT_ID" >> $GITHUB_OUTPUT
          else
            echo "Fetching Cloudflare accounts..."
            curl -s -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN_ZONE_CREATE" \
              "https://api.cloudflare.com/client/v4/accounts" > accounts.json
            echo "Response saved to accounts.json"
            ID=$(jq -r '.result[0].id // empty' accounts.json)
            if [ -z "$ID" ]; then echo "Failed to resolve account id"; cat accounts.json; exit 1; fi
            echo "id=$ID" >> $GITHUB_OUTPUT
          fi

      - name: Dry-run or Create zone
        env:
          ACCOUNT_ID: ${{ steps.acct.outputs.id }}
        run: |
          echo "Prepared to add zone: ${{ inputs.domain }} to account: $ACCOUNT_ID"
          if [ "${{ inputs.apply }}" != "true" ]; then
            echo "DRY-RUN: Would POST /zones with {name: ${{ inputs.domain }}, account: {id: $ACCOUNT_ID}}"; exit 0
          fi
          payload=$(jq -n --arg name "${{ inputs.domain }}" --arg id "$ACCOUNT_ID" '{name: $name, account: {id: $id}}')
          curl -s -X POST -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN_ZONE_CREATE" -H "Content-Type: application/json" \
            -d "$payload" "https://api.cloudflare.com/client/v4/zones" > create_zone.json
          cat create_zone.json
          ok=$(jq -r '.success' create_zone.json)
          if [ "$ok" != "true" ]; then echo "Zone create failed"; exit 1; fi
          echo "Zone create succeeded"
