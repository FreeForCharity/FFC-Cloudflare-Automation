name: DNS Summary Export

on:
  workflow_dispatch:
    inputs:
      zones:
        description: "Comma-separated zone names (e.g., example.org,example.com)"
        required: false
        type: string
      all_zones:
        description: "Export for all zones accessible to the token"
        required: false
        type: boolean
      drive_dns:
        description: "Also run Cloudflare DNS Update via reusable workflow"
        required: false
        type: boolean
      domain:
        description: "Domain for DNS Update"
        required: false
        type: string
      pages_host:
        description: "GitHub Pages hostname"
        required: false
        type: string
      mode:
        description: "DNS update mode (github-pages-a-aaaa | apex-cname | revert-apex-a)"
        required: false
        type: string
      apex_a:
        description: "IPv4 for revert-apex-a"
        required: false
        type: string
      purge:
        description: "Purge other A/CNAME"
        required: false
        type: boolean
      apply:
        description: "Apply changes (default dry-run)"
        required: false
        type: boolean

jobs:
  export:
    runs-on: windows-latest
    environment: cloudflare-prod
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run DNS summary exporter
        env:
          # Prefer READ_ALL; fallback to DNS_ONLY
          CLOUDFLARE_API_KEY_READ_ALL: ${{ secrets.CLOUDFLARE_API_KEY_READ_ALL }}
          CLOUDFLARE_API_KEY_DNS_ONLY: ${{ secrets.CLOUDFLARE_API_KEY_DNS_ONLY }}
        run: |
          if ("${{ inputs.all_zones }}" -eq "true") {
            python export_zone_dns_summary.py --all-zones --output zone_dns_summary.csv
          } elseif (-not [string]::IsNullOrEmpty("${{ inputs.zones }}")) {
            python export_zone_dns_summary.py --zones "${{ inputs.zones }}" --output zone_dns_summary.csv
          } else {
            Write-Host "No zones provided and all_zones not set. Defaulting to --all-zones."
            python export_zone_dns_summary.py --all-zones --output zone_dns_summary.csv
          }

      - name: Upload CSV artifact
        uses: actions/upload-artifact@v4
        with:
          name: zone_dns_summary
          path: zone_dns_summary.csv

  drive-dns-update:
    if: ${{ inputs.drive_dns == true }}
    uses: FreeForCharity/FFC-Cloudflare-Automation-/.github/workflows/cloudflare-dns.yml@main
    secrets: inherit
    with:
      domain: ${{ inputs.domain }}
      pages_host: ${{ inputs.pages_host }}
      mode: ${{ inputs.mode }}
      apex_a: ${{ inputs.apex_a }}
      purge: ${{ inputs.purge }}
      apply: ${{ inputs.apply }}
